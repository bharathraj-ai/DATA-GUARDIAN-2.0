{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/bhara/Downloads/DATA%20GAURDIAN/DATA%20GAURDIAN/DATA-GUARDIAN-2.0/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n  prisma: PrismaClient | undefined;\r\n};\r\n\r\n// Create new client only if one doesn't exist\r\nfunction createPrismaClient(): PrismaClient {\r\n  const client = new PrismaClient({\r\n    // Minimal logging for performance - only errors\r\n    log: ['error'],\r\n  });\r\n\r\n  return client;\r\n}\r\n\r\n// Use existing client or create new one\r\nexport const prisma = globalForPrisma.prisma ?? createPrismaClient();\r\n\r\n// Cache client in development to prevent hot-reload memory leaks\r\nif (process.env.NODE_ENV !== 'production') {\r\n  globalForPrisma.prisma = prisma;\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIxB,8CAA8C;AAC9C,SAAS;IACP,MAAM,SAAS,IAAI,4OAAY,CAAC;QAC9B,gDAAgD;QAChD,KAAK;YAAC;SAAQ;IAChB;IAEA,OAAO;AACT;AAGO,MAAM,SAAS,gBAAgB,MAAM,IAAI;AAEhD,iEAAiE;AACjE,wCAA2C;IACzC,gBAAgB,MAAM,GAAG;AAC3B"}},
    {"offset": {"line": 84, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/bhara/Downloads/DATA%20GAURDIAN/DATA%20GAURDIAN/DATA-GUARDIAN-2.0/src/lib/crypto.ts"],"sourcesContent":["import { v4 as uuidv4 } from 'uuid';\r\nimport bcrypt from 'bcryptjs';\r\nimport crypto from 'crypto';\r\n\r\n// ============================================\r\n// TOKEN & OTP UTILITIES\r\n// ============================================\r\n\r\n/**\r\n * Generates a cryptographically secure token using UUID v4\r\n */\r\nexport function generateSecureToken(): string {\r\n    return uuidv4();\r\n}\r\n\r\n/**\r\n * Generates a 6-digit OTP using crypto for better randomness\r\n */\r\nexport function generateOTP(): string {\r\n    const buffer = crypto.randomBytes(4);\r\n    const num = buffer.readUInt32BE(0);\r\n    const otp = (num % 900000) + 100000;\r\n    return otp.toString();\r\n}\r\n\r\n/**\r\n * Hashes an OTP using HMAC-SHA256 (fast, secure for short-lived tokens)\r\n * \r\n * For 6-digit OTPs with 5-minute expiry and 3-attempt limit, HMAC is more appropriate\r\n * than bcrypt because:\r\n * - OTPs are short-lived (brute-force window is minimal)\r\n * - We need fast verification for good UX\r\n * - HMAC with a secret key provides sufficient security\r\n */\r\nexport async function hashOTP(otp: string): Promise<string> {\r\n    const secret = process.env.ENCRYPTION_KEY || 'fallback-secret';\r\n    return crypto.createHmac('sha256', secret).update(otp).digest('hex');\r\n}\r\n\r\n/**\r\n * Verifies an OTP against its hash\r\n * Supports both new HMAC hashes and legacy bcrypt hashes for backward compatibility\r\n */\r\nexport async function verifyOTPHash(otp: string, hash: string): Promise<boolean> {\r\n    // Check if it's a bcrypt hash (starts with $2a$, $2b$, or $2y$)\r\n    if (hash.startsWith('$2')) {\r\n        // Legacy bcrypt verification for existing OTPs\r\n        return bcrypt.compare(otp, hash);\r\n    }\r\n\r\n    // Fast HMAC verification for new OTPs\r\n    const secret = process.env.ENCRYPTION_KEY || 'fallback-secret';\r\n    const computedHash = crypto.createHmac('sha256', secret).update(otp).digest('hex');\r\n\r\n    // Constant-time comparison to prevent timing attacks\r\n    return crypto.timingSafeEqual(Buffer.from(computedHash), Buffer.from(hash));\r\n}\r\n\r\n/**\r\n * Calculates expiry timestamp from minutes\r\n */\r\nexport function calculateExpiry(minutes: number): Date {\r\n    const now = new Date();\r\n    return new Date(now.getTime() + minutes * 60 * 1000);\r\n}\r\n\r\n// ============================================\r\n// AES-256-GCM ENCRYPTION UTILITIES\r\n// ============================================\r\n\r\nconst ALGORITHM = 'aes-256-gcm';\r\nconst IV_LENGTH = 16; // 128 bits\r\nconst AUTH_TAG_LENGTH = 16; // 128 bits\r\nconst KEY_LENGTH = 32; // 256 bits\r\n\r\n/**\r\n * Generates a new 256-bit encryption key\r\n * Store this securely in environment variables\r\n */\r\nexport function generateEncryptionKey(): string {\r\n    return crypto.randomBytes(KEY_LENGTH).toString('hex');\r\n}\r\n\r\n// Cache the encryption key to avoid repeated env parsing\r\nlet _cachedKey: Buffer | null = null;\r\n\r\nfunction getEncryptionKey(): Buffer {\r\n    if (_cachedKey) return _cachedKey;\r\n\r\n    const keyHex = process.env.ENCRYPTION_KEY;\r\n    if (!keyHex) {\r\n        throw new Error('ENCRYPTION_KEY not configured in environment variables');\r\n    }\r\n    if (keyHex.length !== 64) {\r\n        throw new Error('ENCRYPTION_KEY must be 64 hex characters (256 bits)');\r\n    }\r\n    _cachedKey = Buffer.from(keyHex, 'hex');\r\n    return _cachedKey;\r\n}\r\n\r\n/**\r\n * Encrypts data using AES-256-GCM\r\n * \r\n * Security features:\r\n * - Unique IV for each encryption (no pattern leakage)\r\n * - Authentication tag (detects tampering)\r\n * - 256-bit key strength\r\n * \r\n * @param data - Object to encrypt\r\n * @returns Encrypted string in format: iv:authTag:ciphertext (all hex encoded)\r\n */\r\nexport function encryptData(data: object): string {\r\n    const key = getEncryptionKey();\r\n    const iv = crypto.randomBytes(IV_LENGTH);\r\n\r\n    const cipher = crypto.createCipheriv(ALGORITHM, key, iv, {\r\n        authTagLength: AUTH_TAG_LENGTH,\r\n    });\r\n\r\n    const plaintext = JSON.stringify(data);\r\n    let ciphertext = cipher.update(plaintext, 'utf8', 'hex');\r\n    ciphertext += cipher.final('hex');\r\n\r\n    const authTag = cipher.getAuthTag();\r\n\r\n    // Format: iv:authTag:ciphertext\r\n    return `${iv.toString('hex')}:${authTag.toString('hex')}:${ciphertext}`;\r\n}\r\n\r\n/**\r\n * Decrypts data encrypted with encryptData\r\n * \r\n * @param encryptedString - String in format iv:authTag:ciphertext\r\n * @returns Decrypted object\r\n * @throws Error if decryption fails (wrong key, tampered data, etc.)\r\n */\r\nexport function decryptData<T = object>(encryptedString: string): T {\r\n    const key = getEncryptionKey();\r\n\r\n    const parts = encryptedString.split(':');\r\n    if (parts.length !== 3) {\r\n        throw new Error('Invalid encrypted data format');\r\n    }\r\n\r\n    const [ivHex, authTagHex, ciphertext] = parts;\r\n    const iv = Buffer.from(ivHex, 'hex');\r\n    const authTag = Buffer.from(authTagHex, 'hex');\r\n\r\n    if (iv.length !== IV_LENGTH) {\r\n        throw new Error('Invalid IV length');\r\n    }\r\n    if (authTag.length !== AUTH_TAG_LENGTH) {\r\n        throw new Error('Invalid auth tag length');\r\n    }\r\n\r\n    const decipher = crypto.createDecipheriv(ALGORITHM, key, iv, {\r\n        authTagLength: AUTH_TAG_LENGTH,\r\n    });\r\n    decipher.setAuthTag(authTag);\r\n\r\n    let plaintext = decipher.update(ciphertext, 'hex', 'utf8');\r\n    plaintext += decipher.final('utf8');\r\n\r\n    return JSON.parse(plaintext) as T;\r\n}\r\n\r\n/**\r\n * Encrypts raw binary data (Buffer) for file storage\r\n */\r\nexport function encryptBuffer(buffer: Buffer): { iv: string; authTag: string; encryptedContent: Buffer } {\r\n    const key = getEncryptionKey();\r\n    const iv = crypto.randomBytes(IV_LENGTH);\r\n\r\n    const cipher = crypto.createCipheriv(ALGORITHM, key, iv, {\r\n        authTagLength: AUTH_TAG_LENGTH,\r\n    });\r\n\r\n    const encryptedContent = Buffer.concat([\r\n        cipher.update(buffer),\r\n        cipher.final(),\r\n    ]);\r\n\r\n    const authTag = cipher.getAuthTag();\r\n\r\n    return {\r\n        iv: iv.toString('hex'),\r\n        authTag: authTag.toString('hex'),\r\n        encryptedContent,\r\n    };\r\n}\r\n\r\n/**\r\n * Decrypts raw binary data\r\n */\r\nexport function decryptBuffer(encryptedContent: Buffer, ivHex: string, authTagHex: string): Buffer {\r\n    const key = getEncryptionKey();\r\n    const iv = Buffer.from(ivHex, 'hex');\r\n    const authTag = Buffer.from(authTagHex, 'hex');\r\n\r\n    const decipher = crypto.createDecipheriv(ALGORITHM, key, iv, {\r\n        authTagLength: AUTH_TAG_LENGTH,\r\n    });\r\n    decipher.setAuthTag(authTag);\r\n\r\n    return Buffer.concat([\r\n        decipher.update(encryptedContent),\r\n        decipher.final(),\r\n    ]);\r\n}\r\n\r\n/**\r\n * Generates a SHA-256 hash of data for integrity checking\r\n * This hash is stored alongside encrypted data to verify integrity\r\n */\r\nexport function generateDataHash(data: object): string {\r\n    const json = JSON.stringify(data);\r\n    return crypto.createHash('sha256').update(json).digest('hex');\r\n}\r\n\r\n/**\r\n * Generates a unique session ID for Redis sessions\r\n */\r\nexport function generateSessionId(): string {\r\n    return crypto.randomBytes(32).toString('hex');\r\n}\r\n\r\n/**\r\n * Generates an owner token for kill switch functionality\r\n * This is separate from the share token and only given to the data owner\r\n */\r\nexport function generateOwnerToken(): string {\r\n    return crypto.randomBytes(24).toString('base64url');\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 251, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/bhara/Downloads/DATA%20GAURDIAN/DATA%20GAURDIAN/DATA-GUARDIAN-2.0/src/lib/validations.ts"],"sourcesContent":["import { z } from 'zod';\r\n\r\nexport const userDataSchema = z.object({\r\n    firstName: z.string().min(1, 'First name is required').max(50, 'First name too long'),\r\n    lastName: z.string().min(1, 'Last name is required').max(50, 'Last name too long'),\r\n    email: z.string().email('Invalid email address'),\r\n    phone: z.string().min(10, 'Phone number must be at least 10 digits').max(15, 'Phone number too long'),\r\n    gender: z.enum(['male', 'female', 'other', 'prefer-not-to-say'], {\r\n        message: 'Please select a valid gender option',\r\n    }),\r\n    age: z.number().int().min(1, 'Age must be at least 1').max(150, 'Invalid age'),\r\n    validityMinutes: z.number().int().min(1, 'Validity must be at least 1 minute').max(1440, 'Validity cannot exceed 24 hours'),\r\n});\r\n\r\nexport type UserDataInput = z.infer<typeof userDataSchema>;\r\n\r\nexport const otpVerifySchema = z.object({\r\n    token: z.string().uuid('Invalid link token'),\r\n    otp: z.string().length(6, 'OTP must be 6 digits').regex(/^\\d+$/, 'OTP must contain only digits'),\r\n});\r\n\r\nexport type OTPVerifyInput = z.infer<typeof otpVerifySchema>;\r\n\r\nexport const MAX_FILE_SIZE = 15 * 1024 * 1024; // 15MB\r\nexport const MAX_TOTAL_SIZE = 50 * 1024 * 1024; // 50MB Total\r\n\r\nexport const ACCEPTED_FILE_TYPES = [\r\n    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx\r\n    'application/vnd.ms-excel', // .xls\r\n    'text/csv', // .csv\r\n    'image/png', // .png\r\n    'image/jpeg', // .jpg, .jpeg\r\n    'application/pdf', // .pdf\r\n    'text/plain', // .txt\r\n];\r\n\r\nexport const fileSchema = z.object({\r\n    size: z.number().max(MAX_FILE_SIZE, 'File size must be less than 15MB'),\r\n    type: z.enum([ACCEPTED_FILE_TYPES[0], ...ACCEPTED_FILE_TYPES.slice(1)] as [string, ...string[]], {\r\n        message: 'Invalid file type. Allowed: Excel, CSV, Images, PDF, Text',\r\n    }),\r\n});\r\n\r\n// ============================================\r\n// V2.1 ADDITIONS - PURPOSE TAGS\r\n// ============================================\r\n\r\nexport const SharePurposeSchema = z.enum([\r\n    'VERIFICATION',\r\n    'REVIEW',\r\n    'AUDIT',\r\n    'COLLABORATION',\r\n    'COMPLIANCE',\r\n    'SUPPORT',\r\n    'OTHER'\r\n], {\r\n    message: 'Please select a valid purpose category'\r\n});\r\n\r\nexport type SharePurpose = z.infer<typeof SharePurposeSchema>;\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;AAEO,MAAM,iBAAiB,iQAAC,CAAC,MAAM,CAAC;IACnC,WAAW,iQAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,0BAA0B,GAAG,CAAC,IAAI;IAC/D,UAAU,iQAAC,CAAC,MAAM,GAAG,GAAG,CAAC,GAAG,yBAAyB,GAAG,CAAC,IAAI;IAC7D,OAAO,iQAAC,CAAC,MAAM,GAAG,KAAK,CAAC;IACxB,OAAO,iQAAC,CAAC,MAAM,GAAG,GAAG,CAAC,IAAI,2CAA2C,GAAG,CAAC,IAAI;IAC7E,QAAQ,iQAAC,CAAC,IAAI,CAAC;QAAC;QAAQ;QAAU;QAAS;KAAoB,EAAE;QAC7D,SAAS;IACb;IACA,KAAK,iQAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,0BAA0B,GAAG,CAAC,KAAK;IAChE,iBAAiB,iQAAC,CAAC,MAAM,GAAG,GAAG,GAAG,GAAG,CAAC,GAAG,sCAAsC,GAAG,CAAC,MAAM;AAC7F;AAIO,MAAM,kBAAkB,iQAAC,CAAC,MAAM,CAAC;IACpC,OAAO,iQAAC,CAAC,MAAM,GAAG,IAAI,CAAC;IACvB,KAAK,iQAAC,CAAC,MAAM,GAAG,MAAM,CAAC,GAAG,wBAAwB,KAAK,CAAC,SAAS;AACrE;AAIO,MAAM,gBAAgB,KAAK,OAAO,MAAM,OAAO;AAC/C,MAAM,iBAAiB,KAAK,OAAO,MAAM,aAAa;AAEtD,MAAM,sBAAsB;IAC/B;IACA;IACA;IACA;IACA;IACA;IACA;CACH;AAEM,MAAM,aAAa,iQAAC,CAAC,MAAM,CAAC;IAC/B,MAAM,iQAAC,CAAC,MAAM,GAAG,GAAG,CAAC,eAAe;IACpC,MAAM,iQAAC,CAAC,IAAI,CAAC;QAAC,mBAAmB,CAAC,EAAE;WAAK,oBAAoB,KAAK,CAAC;KAAG,EAA2B;QAC7F,SAAS;IACb;AACJ;AAMO,MAAM,qBAAqB,iQAAC,CAAC,IAAI,CAAC;IACrC;IACA;IACA;IACA;IACA;IACA;IACA;CACH,EAAE;IACC,SAAS;AACb"}},
    {"offset": {"line": 324, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/bhara/Downloads/DATA%20GAURDIAN/DATA%20GAURDIAN/DATA-GUARDIAN-2.0/src/actions/create-link-with-files.ts"],"sourcesContent":["'use server';\r\n\r\nimport { prisma } from '@/lib/prisma';\r\nimport {\r\n    generateSecureToken,\r\n    generateOTP,\r\n    hashOTP,\r\n    calculateExpiry,\r\n    encryptData,\r\n    generateDataHash,\r\n    generateOwnerToken,\r\n    encryptBuffer\r\n} from '@/lib/crypto';\r\nimport { userDataSchema, fileSchema, ACCEPTED_FILE_TYPES } from '@/lib/validations';\r\nimport { z } from 'zod';\r\n\r\nexport type CreateSecureLinkResult = {\r\n    success: boolean;\r\n    shareUrl?: string;\r\n    ownerUrl?: string;\r\n    otp?: string;\r\n    expiresAt?: Date;\r\n    purpose?: string;  // V2.1: Return purpose for confirmation\r\n    error?: string;\r\n};\r\n\r\nexport async function createSecureLinkWithFiles(formData: FormData): Promise<CreateSecureLinkResult> {\r\n    try {\r\n        // 1. Extract and Validate Text Data\r\n        const rawData = {\r\n            firstName: formData.get('firstName'),\r\n            lastName: formData.get('lastName'),\r\n            email: formData.get('email'),\r\n            phone: formData.get('phone'),\r\n            gender: formData.get('gender'),\r\n            age: Number(formData.get('age')),\r\n            validityMinutes: Number(formData.get('validityMinutes')),\r\n        };\r\n\r\n        // V2.1: Extract purpose and notification fields\r\n        const purpose = formData.get('purpose') as string | null;\r\n        const purposeDetail = formData.get('purposeDetail') as string | null;\r\n        const notificationEmail = formData.get('notificationEmail') as string | null;\r\n\r\n        const validatedData = userDataSchema.safeParse(rawData);\r\n        if (!validatedData.success) {\r\n            return {\r\n                success: false,\r\n                error: validatedData.error.issues[0]?.message || 'Invalid input data',\r\n            };\r\n        }\r\n\r\n        // 2. Extract and Process Files\r\n        const files: File[] = [];\r\n        const fileEntries = formData.getAll('files');\r\n\r\n        for (const entry of fileEntries) {\r\n            if (entry instanceof File && entry.size > 0) {\r\n                files.push(entry);\r\n            }\r\n        }\r\n\r\n        // FAST-FAIL: Validate file count and total size upfront\r\n        const MAX_FILES = 50;\r\n        const MAX_TOTAL_SIZE = 100 * 1024 * 1024; // 100MB total\r\n\r\n        if (files.length > MAX_FILES) {\r\n            return {\r\n                success: false,\r\n                error: `Too many files. Maximum ${MAX_FILES} files allowed (you selected ${files.length}).`,\r\n            };\r\n        }\r\n\r\n        const totalSize = files.reduce((sum, f) => sum + f.size, 0);\r\n        if (totalSize > MAX_TOTAL_SIZE) {\r\n            return {\r\n                success: false,\r\n                error: `Total file size exceeds 100MB limit (${(totalSize / 1024 / 1024).toFixed(1)}MB selected).`,\r\n            };\r\n        }\r\n\r\n        // Validate all files first (fast check)\r\n        for (const file of files) {\r\n            const validation = fileSchema.safeParse({ size: file.size, type: file.type });\r\n            if (!validation.success) {\r\n                return {\r\n                    success: false,\r\n                    error: `File ${file.name}: ${validation.error.issues[0]?.message}`,\r\n                };\r\n            }\r\n        }\r\n\r\n        const { firstName, lastName, email, phone, gender, age, validityMinutes } = validatedData.data;\r\n\r\n        // 3. Prepare User Data for Encryption\r\n        const userData = {\r\n            firstName,\r\n            lastName,\r\n            email,\r\n            phone,\r\n            gender,\r\n            age,\r\n        };\r\n\r\n        // 4. Generate Security Artifacts - PARALLELIZE crypto operations\r\n        const token = generateSecureToken();\r\n        const ownerToken = generateOwnerToken();\r\n        const otp = generateOTP();\r\n        const expiresAt = calculateExpiry(validityMinutes);\r\n\r\n        // Run OTP hashing, user data encryption, and file encryption IN PARALLEL\r\n        const [otpHash, encryptedUserData, dataHash, encryptedFiles] = await Promise.all([\r\n            hashOTP(otp),\r\n            Promise.resolve(encryptData(userData)),\r\n            Promise.resolve(generateDataHash(userData)),\r\n            Promise.all(\r\n                files.map(async (file) => {\r\n                    const buffer = Buffer.from(await file.arrayBuffer());\r\n                    const { iv, authTag, encryptedContent } = encryptBuffer(buffer);\r\n                    return {\r\n                        fileName: file.name,\r\n                        fileType: file.type,\r\n                        fileSize: file.size,\r\n                        encryptedContent,\r\n                        iv,\r\n                        authTag,\r\n                    };\r\n                })\r\n            ),\r\n        ]);\r\n\r\n        // 5. Database Transaction - Optimized with shorter timeout\r\n        const result = await prisma.$transaction(async (tx) => {\r\n            // Create UserData Record\r\n            const userDataRecord = await tx.userData.create({\r\n                data: {\r\n                    encryptedData: encryptedUserData,\r\n                    dataHash,\r\n                },\r\n            });\r\n\r\n            // Create SecureLink with Files (V2.1 Enhanced)\r\n            const secureLink = await tx.secureLink.create({\r\n                data: {\r\n                    token,\r\n                    ownerToken,\r\n                    otpHash,\r\n                    expiresAt,\r\n                    userId: userDataRecord.id,\r\n                    // V2.1 Additions\r\n                    purpose: purpose || undefined,\r\n                    purposeDetail: purposeDetail || undefined,\r\n                    notificationEmail: notificationEmail || undefined,\r\n                    files: {\r\n                        create: encryptedFiles,\r\n                    },\r\n                },\r\n            });\r\n\r\n            return secureLink;\r\n        }, {\r\n            maxWait: 5000,   // Reduced from 30s - fail fast on connection issues\r\n            timeout: 60000  // Reduced from 5min - most operations should complete quickly\r\n        });\r\n\r\n        // Audit log AFTER transaction (non-blocking, fire-and-forget for speed)\r\n        prisma.auditLog.create({\r\n            data: {\r\n                action: 'CREATED',\r\n                linkId: result.id,\r\n                metadata: JSON.stringify({\r\n                    fileCount: files.length,\r\n                    purpose: purpose || undefined,\r\n                    hasNotifications: !!notificationEmail\r\n                }),\r\n            },\r\n        }).catch(err => console.warn('[AUDIT] Failed to log:', err.message));\r\n\r\n        const baseUrl = process.env.NEXT_PUBLIC_BASE_URL || 'http://localhost:3000';\r\n        const shareUrl = `${baseUrl}/share/${token}`;\r\n        const ownerUrl = `${baseUrl}/revoke/${ownerToken}`;\r\n\r\n        console.log(`[SECURE] Link created with ${files.length} files. ID: ${result.id}`);\r\n\r\n        return {\r\n            success: true,\r\n            shareUrl,\r\n            ownerUrl,\r\n            otp,\r\n            expiresAt,\r\n            purpose: purpose || undefined,  // V2.1: Return for UI confirmation\r\n        };\r\n\r\n    } catch (error) {\r\n        console.error('Error creating secure link:', error instanceof Error ? error.message : 'Unknown error');\r\n        return {\r\n            success: false,\r\n            error: 'Failed to create secure link. Please try again.',\r\n        };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 502, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/bhara/Downloads/DATA%20GAURDIAN/DATA%20GAURDIAN/DATA-GUARDIAN-2.0/src/.next-internal/server/app/signup/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {createSecureLinkWithFiles as '408866afce838797a2a07b2b65b218f26b9d6eb8f5'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA"}}]
}